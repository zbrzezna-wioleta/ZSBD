--Zadanie 1 --
SELECT 
    employee_id,
    first_name,
    last_name,
    salary,
    RANK() OVER (ORDER BY salary DESC) AS ranking
FROM employees
ORDER BY ranking;

SELECT salary, COUNT(*) AS ilu_pracownikow
FROM (
  SELECT salary, RANK() OVER (ORDER BY salary DESC) AS ranking
  FROM employees
)
GROUP BY salary
ORDER BY salary DESC;

-- Zadanie 2 --

SELECT 
    employee_id,
    first_name,
    last_name,
    salary,
    SUM(salary) OVER () AS suma_wszystkich
FROM employees;

SELECT SUM(salary) FROM employees;  

-- Zadanie 3 --

SELECT
    e.employee_id,
    e.last_name,
    p.product_name,
    SUM(s.quantity * s.price) AS wartosc_sprzedazy,
    SUM(SUM(s.quantity * s.price)) 
        OVER (PARTITION BY e.employee_id ORDER BY p.product_name) AS skumulowana_sprzedaz,
    RANK() OVER (ORDER BY SUM(s.quantity * s.price) DESC) AS ranking_sprzedazy
FROM employees e
JOIN sales s ON e.employee_id = s.employee_id
JOIN products p ON s.product_id = p.product_id
GROUP BY e.employee_id, e.last_name, p.product_name
ORDER BY ranking_sprzedazy;

-- Zadanie 4 --

SELECT
  s.sale_id,
  e.last_name                        AS nazwisko_pracownika,
  p.product_name                     AS nazwa_produktu,
  s.price                            AS cena_produktu,
  cnt.transactions_that_day          AS liczba_transakcji_tego_dnia,
  tot.total_paid_that_day            AS suma_zaplacona_tego_dnia,
  LAG(s.price) OVER (PARTITION BY s.product_id ORDER BY s.sale_date, s.sale_id) AS poprzednia_cena,
  LEAD(s.price) OVER (PARTITION BY s.product_id ORDER BY s.sale_date, s.sale_id) AS nastepna_cena
FROM sales s
JOIN employees e ON s.employee_id = e.employee_id
JOIN products p  ON s.product_id  = p.product_id

LEFT JOIN (
  SELECT product_id, TRUNC(sale_date) AS sale_day,
         COUNT(*) AS transactions_that_day
  FROM sales
  GROUP BY product_id, TRUNC(sale_date)
) cnt ON cnt.product_id = s.product_id AND cnt.sale_day = TRUNC(s.sale_date)
LEFT JOIN (
  SELECT product_id, TRUNC(sale_date) AS sale_day,
         SUM(quantity * price) AS total_paid_that_day
  FROM sales
  GROUP BY product_id, TRUNC(sale_date)
) tot ON tot.product_id = s.product_id AND tot.sale_day = TRUNC(s.sale_date)
ORDER BY s.sale_date, s.product_id, s.sale_id;

-- Zadanie 5 --

SELECT
  s.sale_id,
  p.product_name,
  s.price,

  SUM(s.quantity * s.price) OVER (PARTITION BY s.product_id, TRUNC(s.sale_date,'MM')) AS suma_w_miesiacu,

  SUM(s.quantity * s.price) OVER (
        PARTITION BY s.product_id, TRUNC(s.sale_date,'MM')
        ORDER BY TRUNC(s.sale_date), s.sale_date, s.sale_id
        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
  ) AS suma_kumulowana_w_miesiacu
FROM sales s
JOIN products p ON s.product_id = p.product_id
ORDER BY s.product_id, TRUNC(s.sale_date,'MM'), s.sale_date;

-- Zadanie 6 --

WITH ceny_2022 AS (
  SELECT 
    product_id,
    TO_CHAR(sale_date, 'MM-DD') AS dzien_miesiac,
    AVG(price) AS cena_2022
  FROM sales
  WHERE TO_CHAR(sale_date, 'YYYY') = '2022'
  GROUP BY product_id, TO_CHAR(sale_date, 'MM-DD')
),

ceny_2023 AS (
  SELECT 
    product_id,
    TO_CHAR(sale_date, 'MM-DD') AS dzien_miesiac,
    AVG(price) AS cena_2023
  FROM sales
  WHERE TO_CHAR(sale_date, 'YYYY') = '2023'
  GROUP BY product_id, TO_CHAR(sale_date, 'MM-DD')
)

SELECT 
  p.product_name,
  p.product_category,
  NVL(c22.cena_2022, 0) AS cena_2022,
  NVL(c23.cena_2023, 0) AS cena_2023,
  (NVL(c23.cena_2023, 0) - NVL(c22.cena_2022, 0)) AS roznica_cen,
  NVL(c23.dzien_miesiac, c22.dzien_miesiac) AS dzien_miesiac
FROM products p
LEFT JOIN ceny_2022 c22 ON p.product_id = c22.product_id
LEFT JOIN ceny_2023 c23 
  ON p.product_id = c23.product_id 
  AND c22.dzien_miesiac = c23.dzien_miesiac
ORDER BY p.product_name, dzien_miesiac;

-- Zadanie 7 --

WITH product_prices AS (
  SELECT
    s.product_id,
    ROUND(AVG(s.price), 2) AS produkt_avg_price
  FROM sales s
  GROUP BY s.product_id
)
SELECT
  p.product_category                                             AS kategoria,
  p.product_name                                                 AS produkt,
  pp.produkt_avg_price                                           AS cena_produktu,
  MIN(pp.produkt_avg_price) OVER (PARTITION BY p.product_category) AS min_w_kategorii,
  MAX(pp.produkt_avg_price) OVER (PARTITION BY p.product_category) AS max_w_kategorii,
  (MAX(pp.produkt_avg_price) OVER (PARTITION BY p.product_category)
   - MIN(pp.produkt_avg_price) OVER (PARTITION BY p.product_category)) AS roznica_max_min
FROM products p
LEFT JOIN product_prices pp ON p.product_id = pp.product_id
ORDER BY p.product_category, p.product_name;

-- Zadanie 8 --

SELECT
  s.sale_id,
  p.product_name,
  s.sale_date,
  s.price,
  AVG(s.price) OVER (
    PARTITION BY s.product_id
    ORDER BY s.sale_date, s.sale_id
    ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING
  ) AS srednia_kroczaca_3
FROM sales s
JOIN products p ON s.product_id = p.product_id
ORDER BY s.product_id, s.sale_date;

-- Zadanie 9 --

WITH product_prices AS (
  
  SELECT
    p.product_id,
    p.product_name,
    p.product_category,
    ROUND(AVG(s.price), 2) AS price
  FROM products p
  LEFT JOIN sales s ON p.product_id = s.product_id
  GROUP BY p.product_id, p.product_name, p.product_category
)
SELECT
  product_id,
  product_name,
  product_category,
  price,
  RANK() OVER (PARTITION BY product_category ORDER BY price DESC NULLS LAST)      AS rank_w_kategorii,
  DENSE_RANK() OVER (PARTITION BY product_category ORDER BY price DESC NULLS LAST) AS dense_rank_w_kategorii
FROM product_prices
ORDER BY product_category, price DESC NULLS LAST;


-- Zadanie 10 --

SELECT
  s.sale_id,
  e.last_name AS nazwisko,
  p.product_name,
  s.quantity * s.price AS wartosc_zamowienia,
  SUM(s.quantity * s.price) OVER (
      PARTITION BY e.employee_id
      ORDER BY s.sale_date, s.sale_id
      ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
  ) AS wartosc_kumulowana_pracownika,
  RANK() OVER (ORDER BY s.quantity * s.price DESC) AS ranking_globalny_zamowien
FROM sales s
JOIN employees e ON s.employee_id = e.employee_id
JOIN products p  ON s.product_id = p.product_id
ORDER BY e.employee_id, s.sale_date;

-- Zadanie 11 --

SELECT DISTINCT e.first_name, e.last_name, e.job_id
FROM employees e
JOIN sales s ON e.employee_id = s.employee_id
ORDER BY e.last_name, e.first_name;
