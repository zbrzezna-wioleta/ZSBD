-- UTWORZENIE TABEL GLOWNYCH
CREATE TABLE CIN_KINO (
    KINO_ID         NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT CIN_KINO_PK PRIMARY KEY,
    NAZWA           VARCHAR2(100) NOT NULL,
    MIASTO          VARCHAR2(60)  NOT NULL,
    ADRES           VARCHAR2(200) NOT NULL,
    TELEFON         VARCHAR2(20),
    EMAIL           VARCHAR2(120),
    DATA_UTWORZENIA DATE DEFAULT SYSDATE NOT NULL
);

CREATE TABLE CIN_SALA (
    SALA_ID         NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT CIN_SALA_PK PRIMARY KEY,
    KINO_ID         NUMBER NOT NULL,
    NUMER_SALI      NUMBER NOT NULL,
    LICZBA_MIEJSC   NUMBER NOT NULL,
    DATA_UTWORZENIA DATE DEFAULT SYSDATE NOT NULL,
    CONSTRAINT CIN_SALA_KINO_FK FOREIGN KEY (KINO_ID) REFERENCES CIN_KINO(KINO_ID),
    CONSTRAINT CIN_SALA_NUM_UNQ UNIQUE (KINO_ID, NUMER_SALI),
    CONSTRAINT CIN_SALA_LICZBA_MIEJSC_CHK CHECK (LICZBA_MIEJSC > 0),
    CONSTRAINT CIN_SALA_NUMER_SALI_CHK CHECK (NUMER_SALI > 0)
);

CREATE TABLE CIN_FILM (
    FILM_ID         NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT CIN_FILM_PK PRIMARY KEY,
    TYTUL           VARCHAR2(150) NOT NULL,
    CZAS_MIN        NUMBER NOT NULL,
    KATEGORIA       VARCHAR2(50),
    MIN_WIEK        NUMBER DEFAULT 0 NOT NULL,
    DATA_UTWORZENIA DATE DEFAULT SYSDATE NOT NULL,
    CONSTRAINT CIN_FILM_CZAS_CHK CHECK (CZAS_MIN > 0),
    CONSTRAINT CIN_FILM_MIN_WIEK_CHK CHECK (MIN_WIEK >= 0)
);

CREATE TABLE CIN_SEANS (
    SEANS_ID        NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT CIN_SEANS_PK PRIMARY KEY,
    FILM_ID         NUMBER NOT NULL,
    SALA_ID         NUMBER NOT NULL,
    DATA_START      DATE NOT NULL,
    CENA            NUMBER(8,2) DEFAULT 0 NOT NULL,
    STATUS          VARCHAR2(20) DEFAULT 'AKTYWNY' NOT NULL,
    DATA_UTWORZENIA DATE DEFAULT SYSDATE NOT NULL,
    CONSTRAINT CIN_SEANS_FILM_FK FOREIGN KEY (FILM_ID) REFERENCES CIN_FILM(FILM_ID),
    CONSTRAINT CIN_SEANS_SALA_FK FOREIGN KEY (SALA_ID) REFERENCES CIN_SALA(SALA_ID),
    CONSTRAINT CIN_SEANS_CENA_CHK CHECK (CENA >= 0),
    CONSTRAINT CIN_SEANS_STATUS_CHK CHECK (STATUS IN ('AKTYWNY','ANULOWANY','ZAKONCZONY'))
);

CREATE TABLE CIN_KLIENT (
    KLIENT_ID        NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT CIN_KLIENT_PK PRIMARY KEY,
    IMIE             VARCHAR2(60) NOT NULL,
    NAZWISKO         VARCHAR2(80) NOT NULL,
    EMAIL            VARCHAR2(120) NOT NULL,
    TELEFON          VARCHAR2(20),
    DATA_REJESTRACJI DATE DEFAULT SYSDATE NOT NULL,
    AKTYWNY          CHAR(1) DEFAULT 'T' NOT NULL,
    CONSTRAINT CIN_KLIENT_AKTYWNY_CHK CHECK (AKTYWNY IN ('T','N')),
    CONSTRAINT CIN_KLIENT_EMAIL_UNQ UNIQUE (EMAIL)
);

CREATE TABLE CIN_REZERWACJA (
    REZERWACJA_ID   NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT CIN_REZERWACJA_PK PRIMARY KEY,
    KLIENT_ID       NUMBER NOT NULL,
    SEANS_ID        NUMBER NOT NULL,
    STATUS          VARCHAR2(20) DEFAULT 'NOWA' NOT NULL,
    DATA_UTWORZENIA DATE DEFAULT SYSDATE NOT NULL,
    CONSTRAINT CIN_REZ_KLIENT_FK FOREIGN KEY (KLIENT_ID) REFERENCES CIN_KLIENT(KLIENT_ID),
    CONSTRAINT CIN_REZ_SEANS_FK FOREIGN KEY (SEANS_ID) REFERENCES CIN_SEANS(SEANS_ID),
    CONSTRAINT CIN_REZ_STATUS_CHK CHECK (STATUS IN ('NOWA','POTWIERDZONA','ANULOWANA'))
);

CREATE TABLE CIN_REZ_MIEJSCE (
    REZ_MIEJSCE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT CIN_REZ_MIEJSCE_PK PRIMARY KEY,
    REZERWACJA_ID  NUMBER NOT NULL,
    RZAD           NUMBER NOT NULL,
    MIEJSCE        NUMBER NOT NULL,
    CONSTRAINT CIN_REZ_MIEJSCE_REZ_FK FOREIGN KEY (REZERWACJA_ID) REFERENCES CIN_REZERWACJA(REZERWACJA_ID),
    CONSTRAINT CIN_REZ_MIEJSCE_RZAD_CHK CHECK (RZAD > 0),
    CONSTRAINT CIN_REZ_MIEJSCE_MIEJSCE_CHK CHECK (MIEJSCE > 0)
);

CREATE TABLE CIN_PLATNOSC (
    PLATNOSC_ID    NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT CIN_PLATNOSC_PK PRIMARY KEY,
    REZERWACJA_ID  NUMBER NOT NULL,
    KWOTA          NUMBER(8,2) NOT NULL,
    METODA         VARCHAR2(20) DEFAULT 'KARTA' NOT NULL,
    STATUS         VARCHAR2(20) DEFAULT 'ZAPLACONA' NOT NULL,
    DATA_PLATNOSCI DATE DEFAULT SYSDATE NOT NULL,
    CONSTRAINT CIN_PLATNOSC_REZ_FK FOREIGN KEY (REZERWACJA_ID) REFERENCES CIN_REZERWACJA(REZERWACJA_ID),
    CONSTRAINT CIN_PLATNOSC_KWOTA_CHK CHECK (KWOTA >= 0),
    CONSTRAINT CIN_PLATNOSC_METODA_CHK CHECK (METODA IN ('KARTA','GOTOWKA','BLIK')),
    CONSTRAINT CIN_PLATNOSC_STATUS_CHK CHECK (STATUS IN ('ZAPLACONA','ZWROT','ANULOWANA'))
);

-- UTWORZENIE INDEKSOW
CREATE INDEX CIN_SALA_KINO_ID_IX ON CIN_SALA(KINO_ID);
CREATE INDEX CIN_SEANS_FILM_ID_IX ON CIN_SEANS(FILM_ID);
CREATE INDEX CIN_SEANS_SALA_ID_IX ON CIN_SEANS(SALA_ID);
CREATE INDEX CIN_SEANS_DATA_START_IX ON CIN_SEANS(DATA_START);
CREATE INDEX CIN_REZ_KLIENT_ID_IX ON CIN_REZERWACJA(KLIENT_ID);
CREATE INDEX CIN_REZ_SEANS_ID_IX  ON CIN_REZERWACJA(SEANS_ID);
CREATE INDEX CIN_REZ_MIEJ_REZ_ID_IX ON CIN_REZ_MIEJSCE(REZERWACJA_ID);
CREATE INDEX CIN_PLAT_REZ_ID_IX ON CIN_PLATNOSC(REZERWACJA_ID);

-- TABELA LOGOWANIA
CREATE TABLE CIN_LOG_OPERACJA (
    LOG_ID         NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT CIN_LOG_OPERACJA_PK PRIMARY KEY,
    DATA_ZDARZENIA DATE DEFAULT SYSDATE NOT NULL,
    UZYTKOWNIK     VARCHAR2(50) DEFAULT USER NOT NULL,
    TYP_OPERACJI   VARCHAR2(10) NOT NULL,
    OBIEKT         VARCHAR2(50) NOT NULL,
    KLUCZ_OPIS     VARCHAR2(200),
    OPIS           VARCHAR2(4000)
);
CREATE INDEX CIN_LOG_DATA_IX ON CIN_LOG_OPERACJA(DATA_ZDARZENIA);
CREATE INDEX CIN_LOG_OBIEKT_IX ON CIN_LOG_OPERACJA(OBIEKT);

-- TABELE ARCHIWUM
CREATE TABLE CIN_ARC_KLIENT (
    ARC_ID          NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT CIN_ARC_KLIENT_PK PRIMARY KEY,
    KLIENT_ID       NUMBER,
    IMIE            VARCHAR2(60),
    NAZWISKO        VARCHAR2(80),
    EMAIL           VARCHAR2(120),
    TELEFON         VARCHAR2(20),
    DATA_REJESTRACJI DATE,
    AKTYWNY         CHAR(1),
    USUNIETY_AT     DATE DEFAULT SYSDATE NOT NULL,
    USUNIETY_PRZEZ  VARCHAR2(50) DEFAULT USER NOT NULL,
    POWOD           VARCHAR2(200)
);

CREATE TABLE CIN_ARC_REZERWACJA (
    ARC_ID          NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT CIN_ARC_REZERWACJA_PK PRIMARY KEY,
    REZERWACJA_ID   NUMBER,
    KLIENT_ID       NUMBER,
    SEANS_ID        NUMBER,
    STATUS          VARCHAR2(20),
    DATA_UTWORZENIA DATE,
    USUNIETY_AT     DATE DEFAULT SYSDATE NOT NULL,
    USUNIETY_PRZEZ  VARCHAR2(50) DEFAULT USER NOT NULL,
    POWOD           VARCHAR2(200)
);

CREATE TABLE CIN_ARC_SEANS (
    ARC_ID          NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT CIN_ARC_SEANS_PK PRIMARY KEY,
    SEANS_ID        NUMBER,
    FILM_ID         NUMBER,
    SALA_ID         NUMBER,
    DATA_START      DATE,
    CENA            NUMBER(8,2),
    STATUS          VARCHAR2(20),
    DATA_UTWORZENIA DATE,
    USUNIETY_AT     DATE DEFAULT SYSDATE NOT NULL,
    USUNIETY_PRZEZ  VARCHAR2(50) DEFAULT USER NOT NULL,
    POWOD           VARCHAR2(200)
);

-- TABELE PODSUMOWAN
CREATE TABLE CIN_POD_SPRZEDAZ_MIESIAC (
    ROK              NUMBER NOT NULL,
    MIESIAC          NUMBER NOT NULL,
    KINO_ID          NUMBER NOT NULL,
    PRZYCHOD         NUMBER(12,2) DEFAULT 0 NOT NULL,
    LICZBA_PLATNOSCI NUMBER DEFAULT 0 NOT NULL,
    DATA_GENERACJI   DATE DEFAULT SYSDATE NOT NULL,
    CONSTRAINT CIN_POD_SPRZEDAZ_PK PRIMARY KEY (ROK, MIESIAC, KINO_ID),
    CONSTRAINT CIN_POD_SPRZEDAZ_MIES_CHK CHECK (MIESIAC BETWEEN 1 AND 12),
    CONSTRAINT CIN_POD_SPRZEDAZ_KINO_FK FOREIGN KEY (KINO_ID) REFERENCES CIN_KINO(KINO_ID)
);

CREATE TABLE CIN_POD_FREKWENCJA_MIESIAC (
    ROK            NUMBER NOT NULL,
    MIESIAC        NUMBER NOT NULL,
    KINO_ID        NUMBER NOT NULL,
    LICZBA_BILETOW NUMBER DEFAULT 0 NOT NULL,
    LICZBA_SEANSOW NUMBER DEFAULT 0 NOT NULL,
    DATA_GENERACJI DATE DEFAULT SYSDATE NOT NULL,
    CONSTRAINT CIN_POD_FREKWENCJA_PK PRIMARY KEY (ROK, MIESIAC, KINO_ID),
    CONSTRAINT CIN_POD_FREKWENCJA_MIES_CHK CHECK (MIESIAC BETWEEN 1 AND 12),
    CONSTRAINT CIN_POD_FREKWENCJA_KINO_FK FOREIGN KEY (KINO_ID) REFERENCES CIN_KINO(KINO_ID)
);

CREATE TABLE CIN_POD_RANKING_FILM_MIESIAC (
    ROK            NUMBER NOT NULL,
    MIESIAC        NUMBER NOT NULL,
    FILM_ID        NUMBER NOT NULL,
    LICZBA_BILETOW NUMBER DEFAULT 0 NOT NULL,
    RANGA          NUMBER,
    DATA_GENERACJI DATE DEFAULT SYSDATE NOT NULL,
    CONSTRAINT CIN_POD_RANKING_PK PRIMARY KEY (ROK, MIESIAC, FILM_ID),
    CONSTRAINT CIN_POD_RANKING_MIES_CHK CHECK (MIESIAC BETWEEN 1 AND 12),
    CONSTRAINT CIN_POD_RANKING_FILM_FK FOREIGN KEY (FILM_ID) REFERENCES CIN_FILM(FILM_ID)
);

-- TABELE STAGING I WSADOW
CREATE TABLE CIN_STG_FILM (
    STG_ID     NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT CIN_STG_FILM_PK PRIMARY KEY,
    TYTUL      VARCHAR2(150),
    CZAS_MIN   NUMBER,
    KATEGORIA  VARCHAR2(50),
    MIN_WIEK   NUMBER,
    DATA_WPISU DATE DEFAULT SYSDATE NOT NULL
);

CREATE TABLE CIN_STG_SEANS (
    STG_ID      NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT CIN_STG_SEANS_PK PRIMARY KEY,
    TYTUL_FILMU VARCHAR2(150),
    KINO_NAZWA  VARCHAR2(100),
    NUMER_SALI  NUMBER,
    DATA_START  DATE,
    CENA        NUMBER(8,2),
    DATA_WPISU  DATE DEFAULT SYSDATE NOT NULL
);

CREATE TABLE CIN_LAD_BATCH (
    BATCH_ID       NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT CIN_LAD_BATCH_PK PRIMARY KEY,
    TYP_DANYCH     VARCHAR2(30) NOT NULL,
    DATA_START     DATE DEFAULT SYSDATE NOT NULL,
    DATA_KONIEC    DATE,
    ILE_POPRAWNYCH NUMBER DEFAULT 0 NOT NULL,
    ILE_BLEDNYCH   NUMBER DEFAULT 0 NOT NULL,
    OPIS           VARCHAR2(200)
);

CREATE TABLE CIN_LAD_BATCH_WIERSZ (
    WIERSZ_ID   NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT CIN_LAD_BATCH_WIERSZ_PK PRIMARY KEY,
    BATCH_ID    NUMBER NOT NULL,
    DANE_TEKST  VARCHAR2(4000),
    CZY_POPRAWNY CHAR(1) NOT NULL,
    KOMUNIKAT   VARCHAR2(4000),
    DATA_ZAPISU DATE DEFAULT SYSDATE NOT NULL,
    CONSTRAINT CIN_LAD_WIERSZ_BATCH_FK FOREIGN KEY (BATCH_ID) REFERENCES CIN_LAD_BATCH(BATCH_ID),
    CONSTRAINT CIN_LAD_WIERSZ_POPR_CHK CHECK (CZY_POPRAWNY IN ('T','N'))
);

CREATE TABLE CIN_LAD_BLEDY (
    BLAD_ID    NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT CIN_LAD_BLEDY_PK PRIMARY KEY,
    BATCH_ID   NUMBER,
    TABELA_STG VARCHAR2(30),
    STG_ID     NUMBER,
    OPIS_BLEDU VARCHAR2(4000),
    DATA_BLEDU DATE DEFAULT SYSDATE NOT NULL
);

CREATE INDEX CIN_LAD_WIERSZ_BATCH_IX ON CIN_LAD_BATCH_WIERSZ(BATCH_ID);
CREATE INDEX CIN_LAD_BLEDY_BATCH_IX ON CIN_LAD_BLEDY(BATCH_ID);

-- PAKIET LOGOWANIA
CREATE OR REPLACE PACKAGE CIN_PAK_LOG AS
  PROCEDURE LOGUJ(
    P_TYP_OPERACJI IN VARCHAR2,
    P_OBIEKT       IN VARCHAR2,
    P_KLUCZ_OPIS   IN VARCHAR2 DEFAULT NULL,
    P_OPIS         IN VARCHAR2 DEFAULT NULL
  );
END CIN_PAK_LOG;
/
CREATE OR REPLACE PACKAGE BODY CIN_PAK_LOG AS
  PROCEDURE LOGUJ(
    P_TYP_OPERACJI IN VARCHAR2,
    P_OBIEKT       IN VARCHAR2,
    P_KLUCZ_OPIS   IN VARCHAR2 DEFAULT NULL,
    P_OPIS         IN VARCHAR2 DEFAULT NULL
  ) IS
  BEGIN
    INSERT INTO CIN_LOG_OPERACJA (TYP_OPERACJI, OBIEKT, KLUCZ_OPIS, OPIS)
    VALUES (UPPER(P_TYP_OPERACJI), UPPER(P_OBIEKT), P_KLUCZ_OPIS, P_OPIS);
  END;
END CIN_PAK_LOG;
/

-- PAKIET LADOWANIA (FILM+SEANS)
CREATE OR REPLACE PACKAGE CIN_PAK_LADOWANIE AS
  PROCEDURE LADUJ_FILMY_Z_STG(P_OPIS IN VARCHAR2 DEFAULT NULL);
  PROCEDURE LADUJ_SEANSE_Z_STG(P_OPIS IN VARCHAR2 DEFAULT NULL);
END CIN_PAK_LADOWANIE;
/
CREATE OR REPLACE PACKAGE BODY CIN_PAK_LADOWANIE AS

  PROCEDURE LADUJ_FILMY_Z_STG(P_OPIS IN VARCHAR2 DEFAULT NULL) IS
    v_batch_id NUMBER; v_ok NUMBER := 0; v_bad NUMBER := 0; v_msg VARCHAR2(4000);
  BEGIN
    INSERT INTO CIN_LAD_BATCH (TYP_DANYCH, OPIS)
    VALUES ('FILM', P_OPIS)
    RETURNING BATCH_ID INTO v_batch_id;

    FOR r IN (SELECT STG_ID, TYTUL, CZAS_MIN, KATEGORIA, MIN_WIEK FROM CIN_STG_FILM ORDER BY STG_ID) LOOP
      v_msg := NULL;

      IF r.TYTUL IS NULL OR LENGTH(TRIM(r.TYTUL)) < 2 THEN
        v_msg := 'BLEDNY TYTUL';
      ELSIF r.CZAS_MIN IS NULL OR r.CZAS_MIN <= 0 THEN
        v_msg := 'BLEDNY CZAS_MIN';
      ELSIF r.MIN_WIEK IS NOT NULL AND r.MIN_WIEK < 0 THEN
        v_msg := 'BLEDNY MIN_WIEK';
      END IF;

      IF v_msg IS NULL THEN
        INSERT INTO CIN_FILM (TYTUL, CZAS_MIN, KATEGORIA, MIN_WIEK)
        VALUES (r.TYTUL, r.CZAS_MIN, r.KATEGORIA, NVL(r.MIN_WIEK, 0));

        v_ok := v_ok + 1;

        INSERT INTO CIN_LAD_BATCH_WIERSZ (BATCH_ID, DANE_TEKST, CZY_POPRAWNY, KOMUNIKAT)
        VALUES (v_batch_id, 'STG_ID='||r.STG_ID||';TYTUL='||r.TYTUL||';CZAS_MIN='||r.CZAS_MIN, 'T', 'OK');
      ELSE
        v_bad := v_bad + 1;

        INSERT INTO CIN_LAD_BLEDY (BATCH_ID, TABELA_STG, STG_ID, OPIS_BLEDU)
        VALUES (v_batch_id, 'CIN_STG_FILM', r.STG_ID, v_msg);

        INSERT INTO CIN_LAD_BATCH_WIERSZ (BATCH_ID, DANE_TEKST, CZY_POPRAWNY, KOMUNIKAT)
        VALUES (v_batch_id, 'STG_ID='||r.STG_ID||';TYTUL='||NVL(r.TYTUL,'NULL')||';CZAS_MIN='||NVL(TO_CHAR(r.CZAS_MIN),'NULL'), 'N', v_msg);
      END IF;
    END LOOP;

    UPDATE CIN_LAD_BATCH
    SET DATA_KONIEC = SYSDATE, ILE_POPRAWNYCH = v_ok, ILE_BLEDNYCH = v_bad
    WHERE BATCH_ID = v_batch_id;

    CIN_PAK_LOG.LOGUJ('PROC', 'CIN_PAK_LADOWANIE', 'BATCH_ID='||v_batch_id, 'FILM: OK='||v_ok||', BLEDNE='||v_bad);
    COMMIT;
  END;

  PROCEDURE LADUJ_SEANSE_Z_STG(P_OPIS IN VARCHAR2 DEFAULT NULL) IS
    v_batch_id NUMBER; v_ok NUMBER := 0; v_bad NUMBER := 0; v_msg VARCHAR2(4000);
    v_film_id NUMBER; v_sala_id NUMBER;
  BEGIN
    INSERT INTO CIN_LAD_BATCH (TYP_DANYCH, OPIS)
    VALUES ('SEANS', P_OPIS)
    RETURNING BATCH_ID INTO v_batch_id;

    FOR r IN (SELECT STG_ID, TYTUL_FILMU, KINO_NAZWA, NUMER_SALI, DATA_START, CENA FROM CIN_STG_SEANS ORDER BY STG_ID) LOOP
      v_msg := NULL; v_film_id := NULL; v_sala_id := NULL;

      IF r.TYTUL_FILMU IS NULL OR LENGTH(TRIM(r.TYTUL_FILMU)) < 2 THEN
        v_msg := 'BLEDNY TYTUL_FILMU';
      ELSIF r.KINO_NAZWA IS NULL OR LENGTH(TRIM(r.KINO_NAZWA)) < 2 THEN
        v_msg := 'BLEDNY KINO_NAZWA';
      ELSIF r.NUMER_SALI IS NULL OR r.NUMER_SALI <= 0 THEN
        v_msg := 'BLEDNY NUMER_SALI';
      ELSIF r.DATA_START IS NULL THEN
        v_msg := 'BRAK DATA_START';
      ELSIF r.CENA IS NULL OR r.CENA < 0 THEN
        v_msg := 'BLEDNA CENA';
      END IF;

      IF v_msg IS NULL THEN
        BEGIN
          SELECT FILM_ID INTO v_film_id FROM CIN_FILM WHERE UPPER(TYTUL) = UPPER(TRIM(r.TYTUL_FILMU));
        EXCEPTION
          WHEN NO_DATA_FOUND THEN v_msg := 'NIE ZNALEZIONO FILMU: '||r.TYTUL_FILMU;
          WHEN TOO_MANY_ROWS THEN v_msg := 'WIELE FILMOW O TYTULE: '||r.TYTUL_FILMU;
        END;
      END IF;

      IF v_msg IS NULL THEN
        BEGIN
          SELECT s.SALA_ID INTO v_sala_id
          FROM CIN_SALA s JOIN CIN_KINO k ON k.KINO_ID = s.KINO_ID
          WHERE UPPER(k.NAZWA) = UPPER(TRIM(r.KINO_NAZWA)) AND s.NUMER_SALI = r.NUMER_SALI;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN v_msg := 'NIE ZNALEZIONO SALI: '||r.KINO_NAZWA||', NR='||r.NUMER_SALI;
          WHEN TOO_MANY_ROWS THEN v_msg := 'WIELE SAL DLA: '||r.KINO_NAZWA||', NR='||r.NUMER_SALI;
        END;
      END IF;

      IF v_msg IS NULL THEN
        INSERT INTO CIN_SEANS (FILM_ID, SALA_ID, DATA_START, CENA, STATUS)
        VALUES (v_film_id, v_sala_id, r.DATA_START, r.CENA, 'AKTYWNY');

        v_ok := v_ok + 1;

        INSERT INTO CIN_LAD_BATCH_WIERSZ (BATCH_ID, DANE_TEKST, CZY_POPRAWNY, KOMUNIKAT)
        VALUES (v_batch_id, 'STG_ID='||r.STG_ID||';FILM='||r.TYTUL_FILMU||';KINO='||r.KINO_NAZWA||';SALA='||r.NUMER_SALI, 'T', 'OK');
      ELSE
        v_bad := v_bad + 1;

        INSERT INTO CIN_LAD_BLEDY (BATCH_ID, TABELA_STG, STG_ID, OPIS_BLEDU)
        VALUES (v_batch_id, 'CIN_STG_SEANS', r.STG_ID, v_msg);

        INSERT INTO CIN_LAD_BATCH_WIERSZ (BATCH_ID, DANE_TEKST, CZY_POPRAWNY, KOMUNIKAT)
        VALUES (v_batch_id, 'STG_ID='||r.STG_ID||';FILM='||NVL(r.TYTUL_FILMU,'NULL')||';KINO='||NVL(r.KINO_NAZWA,'NULL')||';SALA='||NVL(TO_CHAR(r.NUMER_SALI),'NULL'), 'N', v_msg);
      END IF;
    END LOOP;

    UPDATE CIN_LAD_BATCH
    SET DATA_KONIEC = SYSDATE, ILE_POPRAWNYCH = v_ok, ILE_BLEDNYCH = v_bad
    WHERE BATCH_ID = v_batch_id;

    CIN_PAK_LOG.LOGUJ('PROC', 'CIN_PAK_LADOWANIE', 'BATCH_ID='||v_batch_id, 'SEANS: OK='||v_ok||', BLEDNE='||v_bad);
    COMMIT;
  END;

END CIN_PAK_LADOWANIE;
/

-- PAKIET SEANS (CRUD+WYJATKI+LOG+ARCHIWUM)
CREATE OR REPLACE PACKAGE CIN_PAK_SEANS AS
  e_brak_filmu     EXCEPTION;
  e_brak_sali      EXCEPTION;
  e_kolizja_seansu EXCEPTION;

  PROCEDURE DODAJ_SEANS(P_FILM_ID IN NUMBER, P_SALA_ID IN NUMBER, P_DATA_START IN DATE, P_CENA IN NUMBER DEFAULT 0, P_STATUS IN VARCHAR2 DEFAULT 'AKTYWNY');
  PROCEDURE ZMIEN_SEANS(P_SEANS_ID IN NUMBER, P_DATA_START IN DATE, P_CENA IN NUMBER, P_STATUS IN VARCHAR2);
  PROCEDURE USUN_SEANS(P_SEANS_ID IN NUMBER, P_POWOD IN VARCHAR2 DEFAULT NULL);
END CIN_PAK_SEANS;
/
CREATE OR REPLACE PACKAGE BODY CIN_PAK_SEANS AS

  FUNCTION ISTNIEJE_FILM(P_FILM_ID NUMBER) RETURN BOOLEAN IS v_cnt NUMBER;
  BEGIN SELECT COUNT(*) INTO v_cnt FROM CIN_FILM WHERE FILM_ID = P_FILM_ID; RETURN v_cnt = 1; END;

  FUNCTION ISTNIEJE_SALA(P_SALA_ID NUMBER) RETURN BOOLEAN IS v_cnt NUMBER;
  BEGIN SELECT COUNT(*) INTO v_cnt FROM CIN_SALA WHERE SALA_ID = P_SALA_ID; RETURN v_cnt = 1; END;

  FUNCTION JEST_KOLIZJA(P_SALA_ID NUMBER, P_DATA_START DATE, P_POMIN_SEANS_ID NUMBER DEFAULT NULL) RETURN BOOLEAN IS v_cnt NUMBER;
  BEGIN
    SELECT COUNT(*) INTO v_cnt
    FROM CIN_SEANS
    WHERE SALA_ID = P_SALA_ID AND DATA_START = P_DATA_START
      AND (P_POMIN_SEANS_ID IS NULL OR SEANS_ID <> P_POMIN_SEANS_ID);
    RETURN v_cnt > 0;
  END;

  PROCEDURE DODAJ_SEANS(P_FILM_ID IN NUMBER, P_SALA_ID IN NUMBER, P_DATA_START IN DATE, P_CENA IN NUMBER DEFAULT 0, P_STATUS IN VARCHAR2 DEFAULT 'AKTYWNY') IS
    v_seans_id NUMBER;
  BEGIN
    IF NOT ISTNIEJE_FILM(P_FILM_ID) THEN RAISE e_brak_filmu; END IF;
    IF NOT ISTNIEJE_SALA(P_SALA_ID) THEN RAISE e_brak_sali; END IF;
    IF JEST_KOLIZJA(P_SALA_ID, P_DATA_START) THEN RAISE e_kolizja_seansu; END IF;

    INSERT INTO CIN_SEANS (FILM_ID, SALA_ID, DATA_START, CENA, STATUS)
    VALUES (P_FILM_ID, P_SALA_ID, P_DATA_START, NVL(P_CENA,0), NVL(P_STATUS,'AKTYWNY'))
    RETURNING SEANS_ID INTO v_seans_id;

    CIN_PAK_LOG.LOGUJ('INSERT','CIN_SEANS','SEANS_ID='||v_seans_id,'Dodano seans');
    COMMIT;
  EXCEPTION
    WHEN e_brak_filmu THEN
      CIN_PAK_LOG.LOGUJ('PROC','CIN_PAK_SEANS',NULL,'Blad: brak filmu FILM_ID='||P_FILM_ID);
      RAISE_APPLICATION_ERROR(-20001, 'BLAD: Nie istnieje FILM_ID='||P_FILM_ID);
    WHEN e_brak_sali THEN
      CIN_PAK_LOG.LOGUJ('PROC','CIN_PAK_SEANS',NULL,'Blad: brak sali SALA_ID='||P_SALA_ID);
      RAISE_APPLICATION_ERROR(-20002, 'BLAD: Nie istnieje SALA_ID='||P_SALA_ID);
    WHEN e_kolizja_seansu THEN
      CIN_PAK_LOG.LOGUJ('PROC','CIN_PAK_SEANS',NULL,'Blad: kolizja seansu SALA_ID='||P_SALA_ID||', DATA_START='||TO_CHAR(P_DATA_START,'YYYY-MM-DD HH24:MI'));
      RAISE_APPLICATION_ERROR(-20003, 'BLAD: Kolizja seansu (ta sama sala i godzina).');
  END;

  PROCEDURE ZMIEN_SEANS(P_SEANS_ID IN NUMBER, P_DATA_START IN DATE, P_CENA IN NUMBER, P_STATUS IN VARCHAR2) IS
    v_sala_id NUMBER;
  BEGIN
    SELECT SALA_ID INTO v_sala_id FROM CIN_SEANS WHERE SEANS_ID = P_SEANS_ID;

    IF JEST_KOLIZJA(v_sala_id, P_DATA_START, P_SEANS_ID) THEN RAISE e_kolizja_seansu; END IF;

    UPDATE CIN_SEANS SET DATA_START = P_DATA_START, CENA = P_CENA, STATUS = P_STATUS WHERE SEANS_ID = P_SEANS_ID;
    CIN_PAK_LOG.LOGUJ('UPDATE','CIN_SEANS','SEANS_ID='||P_SEANS_ID,'Zmieniono seans');
    COMMIT;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20004, 'BLAD: Nie istnieje SEANS_ID='||P_SEANS_ID);
    WHEN e_kolizja_seansu THEN RAISE_APPLICATION_ERROR(-20003, 'BLAD: Kolizja seansu (ta sama sala i godzina).');
  END;

  PROCEDURE USUN_SEANS(P_SEANS_ID IN NUMBER, P_POWOD IN VARCHAR2 DEFAULT NULL) IS
    v_row CIN_SEANS%ROWTYPE;
  BEGIN
    SELECT * INTO v_row FROM CIN_SEANS WHERE SEANS_ID = P_SEANS_ID;

    INSERT INTO CIN_ARC_SEANS (SEANS_ID, FILM_ID, SALA_ID, DATA_START, CENA, STATUS, DATA_UTWORZENIA, POWOD)
    VALUES (v_row.SEANS_ID, v_row.FILM_ID, v_row.SALA_ID, v_row.DATA_START, v_row.CENA, v_row.STATUS, v_row.DATA_UTWORZENIA, P_POWOD);

    DELETE FROM CIN_SEANS WHERE SEANS_ID = P_SEANS_ID;

    CIN_PAK_LOG.LOGUJ('DELETE','CIN_SEANS','SEANS_ID='||P_SEANS_ID,'Usunieto seans (archiwum)');
    COMMIT;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20004, 'BLAD: Nie istnieje SEANS_ID='||P_SEANS_ID);
  END;

END CIN_PAK_SEANS;
/

-- PAKIET REZERWACJA (FUNKCJA+WYJATKI+LOG+ARCHIWUM)
CREATE OR REPLACE PACKAGE CIN_PAK_REZERWACJA AS
  e_brak_klienta   EXCEPTION;
  e_brak_seansu    EXCEPTION;
  e_miejsce_zajete EXCEPTION;

  FUNCTION UTWORZ_REZERWACJE(P_KLIENT_ID IN NUMBER, P_SEANS_ID IN NUMBER, P_STATUS IN VARCHAR2 DEFAULT 'NOWA') RETURN NUMBER;
  PROCEDURE DODAJ_MIEJSCE(P_REZERWACJA_ID IN NUMBER, P_RZAD IN NUMBER, P_MIEJSCE IN NUMBER);
  PROCEDURE POTWIERDZ_REZERWACJE(P_REZERWACJA_ID IN NUMBER);
  PROCEDURE ANULUJ_REZERWACJE(P_REZERWACJA_ID IN NUMBER, P_POWOD IN VARCHAR2 DEFAULT NULL);
END CIN_PAK_REZERWACJA;
/
CREATE OR REPLACE PACKAGE BODY CIN_PAK_REZERWACJA AS

  FUNCTION ISTNIEJE_KLIENT(P_KLIENT_ID NUMBER) RETURN BOOLEAN IS v_cnt NUMBER;
  BEGIN SELECT COUNT(*) INTO v_cnt FROM CIN_KLIENT WHERE KLIENT_ID = P_KLIENT_ID; RETURN v_cnt = 1; END;

  FUNCTION ISTNIEJE_SEANS(P_SEANS_ID NUMBER) RETURN BOOLEAN IS v_cnt NUMBER;
  BEGIN SELECT COUNT(*) INTO v_cnt FROM CIN_SEANS WHERE SEANS_ID = P_SEANS_ID; RETURN v_cnt = 1; END;

  FUNCTION UTWORZ_REZERWACJE(P_KLIENT_ID IN NUMBER, P_SEANS_ID IN NUMBER, P_STATUS IN VARCHAR2 DEFAULT 'NOWA') RETURN NUMBER IS
    v_rez_id NUMBER;
  BEGIN
    IF NOT ISTNIEJE_KLIENT(P_KLIENT_ID) THEN RAISE e_brak_klienta; END IF;
    IF NOT ISTNIEJE_SEANS(P_SEANS_ID) THEN RAISE e_brak_seansu; END IF;

    INSERT INTO CIN_REZERWACJA (KLIENT_ID, SEANS_ID, STATUS)
    VALUES (P_KLIENT_ID, P_SEANS_ID, NVL(P_STATUS,'NOWA'))
    RETURNING REZERWACJA_ID INTO v_rez_id;

    CIN_PAK_LOG.LOGUJ('INSERT','CIN_REZERWACJA','REZERWACJA_ID='||v_rez_id,'Utworzono rezerwacje');
    COMMIT;
    RETURN v_rez_id;
  EXCEPTION
    WHEN e_brak_klienta THEN
      CIN_PAK_LOG.LOGUJ('PROC','CIN_PAK_REZERWACJA',NULL,'Blad: brak klienta KLIENT_ID='||P_KLIENT_ID);
      RAISE_APPLICATION_ERROR(-20011, 'BLAD: Nie istnieje KLIENT_ID='||P_KLIENT_ID);
    WHEN e_brak_seansu THEN
      CIN_PAK_LOG.LOGUJ('PROC','CIN_PAK_REZERWACJA',NULL,'Blad: brak seansu SEANS_ID='||P_SEANS_ID);
      RAISE_APPLICATION_ERROR(-20012, 'BLAD: Nie istnieje SEANS_ID='||P_SEANS_ID);
  END;

  PROCEDURE DODAJ_MIEJSCE(P_REZERWACJA_ID IN NUMBER, P_RZAD IN NUMBER, P_MIEJSCE IN NUMBER) IS
    v_seans_id NUMBER; v_cnt NUMBER;
  BEGIN
    SELECT SEANS_ID INTO v_seans_id FROM CIN_REZERWACJA WHERE REZERWACJA_ID = P_REZERWACJA_ID;

    SELECT COUNT(*) INTO v_cnt
    FROM CIN_REZ_MIEJSCE rm
    JOIN CIN_REZERWACJA r ON r.REZERWACJA_ID = rm.REZERWACJA_ID
    WHERE r.SEANS_ID = v_seans_id AND rm.RZAD = P_RZAD AND rm.MIEJSCE = P_MIEJSCE;

    IF v_cnt > 0 THEN RAISE e_miejsce_zajete; END IF;

    INSERT INTO CIN_REZ_MIEJSCE (REZERWACJA_ID, RZAD, MIEJSCE)
    VALUES (P_REZERWACJA_ID, P_RZAD, P_MIEJSCE);

    CIN_PAK_LOG.LOGUJ('INSERT','CIN_REZ_MIEJSCE','REZERWACJA_ID='||P_REZERWACJA_ID,'Dodano miejsce: RZAD='||P_RZAD||', MIEJSCE='||P_MIEJSCE);
    COMMIT;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20013, 'BLAD: Nie istnieje REZERWACJA_ID='||P_REZERWACJA_ID);
    WHEN e_miejsce_zajete THEN
      CIN_PAK_LOG.LOGUJ('PROC','CIN_PAK_REZERWACJA',NULL,'Blad: miejsce zajete (REZ_ID='||P_REZERWACJA_ID||')');
      RAISE_APPLICATION_ERROR(-20014, 'BLAD: To miejsce jest juz zajete na tym seansie.');
  END;

  PROCEDURE POTWIERDZ_REZERWACJE(P_REZERWACJA_ID IN NUMBER) IS
  BEGIN
    UPDATE CIN_REZERWACJA SET STATUS = 'POTWIERDZONA' WHERE REZERWACJA_ID = P_REZERWACJA_ID;
    CIN_PAK_LOG.LOGUJ('UPDATE','CIN_REZERWACJA','REZERWACJA_ID='||P_REZERWACJA_ID,'Potwierdzono rezerwacje');
    COMMIT;
  END;

  PROCEDURE ANULUJ_REZERWACJE(P_REZERWACJA_ID IN NUMBER, P_POWOD IN VARCHAR2 DEFAULT NULL) IS
    v_row CIN_REZERWACJA%ROWTYPE;
  BEGIN
    SELECT * INTO v_row FROM CIN_REZERWACJA WHERE REZERWACJA_ID = P_REZERWACJA_ID;

    INSERT INTO CIN_ARC_REZERWACJA (REZERWACJA_ID, KLIENT_ID, SEANS_ID, STATUS, DATA_UTWORZENIA, POWOD)
    VALUES (v_row.REZERWACJA_ID, v_row.KLIENT_ID, v_row.SEANS_ID, v_row.STATUS, v_row.DATA_UTWORZENIA, P_POWOD);

    UPDATE CIN_REZERWACJA SET STATUS = 'ANULOWANA' WHERE REZERWACJA_ID = P_REZERWACJA_ID;

    CIN_PAK_LOG.LOGUJ('UPDATE','CIN_REZERWACJA','REZERWACJA_ID='||P_REZERWACJA_ID,'Anulowano rezerwacje (archiwum)');
    COMMIT;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20013, 'BLAD: Nie istnieje REZERWACJA_ID='||P_REZERWACJA_ID);
  END;

END CIN_PAK_REZERWACJA;
/

-- PAKIET KLIENT (FUNKCJA+WALIDACJA EMAIL+LOG+ARCHIWUM)
CREATE OR REPLACE PACKAGE CIN_PAK_KLIENT AS
  e_bledny_email EXCEPTION;
  e_brak_klienta EXCEPTION;

  FUNCTION DODAJ_KLIENTA(P_IMIE IN VARCHAR2, P_NAZWISKO IN VARCHAR2, P_EMAIL IN VARCHAR2, P_TELEFON IN VARCHAR2 DEFAULT NULL) RETURN NUMBER;
  PROCEDURE ZMIEN_KLIENTA(P_KLIENT_ID IN NUMBER, P_IMIE IN VARCHAR2, P_NAZWISKO IN VARCHAR2, P_EMAIL IN VARCHAR2, P_TELEFON IN VARCHAR2);
  PROCEDURE DEZAKTYWUJ_KLIENTA(P_KLIENT_ID IN NUMBER, P_POWOD IN VARCHAR2 DEFAULT NULL);
END CIN_PAK_KLIENT;
/
CREATE OR REPLACE PACKAGE BODY CIN_PAK_KLIENT AS

  FUNCTION EMAIL_OK(P_EMAIL VARCHAR2) RETURN BOOLEAN IS
  BEGIN
    RETURN REGEXP_LIKE(P_EMAIL, '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$');
  END;

  FUNCTION DODAJ_KLIENTA(P_IMIE IN VARCHAR2, P_NAZWISKO IN VARCHAR2, P_EMAIL IN VARCHAR2, P_TELEFON IN VARCHAR2 DEFAULT NULL) RETURN NUMBER IS
    v_id NUMBER;
  BEGIN
    IF NOT EMAIL_OK(P_EMAIL) THEN RAISE e_bledny_email; END IF;

    INSERT INTO CIN_KLIENT (IMIE, NAZWISKO, EMAIL, TELEFON)
    VALUES (P_IMIE, P_NAZWISKO, LOWER(TRIM(P_EMAIL)), P_TELEFON)
    RETURNING KLIENT_ID INTO v_id;

    CIN_PAK_LOG.LOGUJ('INSERT','CIN_KLIENT','KLIENT_ID='||v_id,'Dodano klienta');
    COMMIT;
    RETURN v_id;
  EXCEPTION
    WHEN e_bledny_email THEN
      CIN_PAK_LOG.LOGUJ('PROC','CIN_PAK_KLIENT',NULL,'Blad: bledny email='||P_EMAIL);
      RAISE_APPLICATION_ERROR(-20021, 'BLAD: Niepoprawny email: '||P_EMAIL);
    WHEN DUP_VAL_ON_INDEX THEN
      RAISE_APPLICATION_ERROR(-20022, 'BLAD: Taki email juz istnieje: '||P_EMAIL);
  END;

  PROCEDURE ZMIEN_KLIENTA(P_KLIENT_ID IN NUMBER, P_IMIE IN VARCHAR2, P_NAZWISKO IN VARCHAR2, P_EMAIL IN VARCHAR2, P_TELEFON IN VARCHAR2) IS
    v_cnt NUMBER;
  BEGIN
    IF NOT EMAIL_OK(P_EMAIL) THEN RAISE e_bledny_email; END IF;

    SELECT COUNT(*) INTO v_cnt FROM CIN_KLIENT WHERE KLIENT_ID = P_KLIENT_ID;
    IF v_cnt = 0 THEN RAISE e_brak_klienta; END IF;

    UPDATE CIN_KLIENT
    SET IMIE = P_IMIE, NAZWISKO = P_NAZWISKO, EMAIL = LOWER(TRIM(P_EMAIL)), TELEFON = P_TELEFON
    WHERE KLIENT_ID = P_KLIENT_ID;

    CIN_PAK_LOG.LOGUJ('UPDATE','CIN_KLIENT','KLIENT_ID='||P_KLIENT_ID,'Zmieniono dane klienta');
    COMMIT;
  EXCEPTION
    WHEN e_bledny_email THEN RAISE_APPLICATION_ERROR(-20021, 'BLAD: Niepoprawny email: '||P_EMAIL);
    WHEN e_brak_klienta THEN RAISE_APPLICATION_ERROR(-20023, 'BLAD: Nie istnieje KLIENT_ID='||P_KLIENT_ID);
    WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20022, 'BLAD: Taki email juz istnieje: '||P_EMAIL);
  END;

  PROCEDURE DEZAKTYWUJ_KLIENTA(P_KLIENT_ID IN NUMBER, P_POWOD IN VARCHAR2 DEFAULT NULL) IS
    v_row CIN_KLIENT%ROWTYPE;
  BEGIN
    SELECT * INTO v_row FROM CIN_KLIENT WHERE KLIENT_ID = P_KLIENT_ID;

    INSERT INTO CIN_ARC_KLIENT (KLIENT_ID, IMIE, NAZWISKO, EMAIL, TELEFON, DATA_REJESTRACJI, AKTYWNY, POWOD)
    VALUES (v_row.KLIENT_ID, v_row.IMIE, v_row.NAZWISKO, v_row.EMAIL, v_row.TELEFON, v_row.DATA_REJESTRACJI, v_row.AKTYWNY, P_POWOD);

    UPDATE CIN_KLIENT SET AKTYWNY = 'N' WHERE KLIENT_ID = P_KLIENT_ID;

    CIN_PAK_LOG.LOGUJ('UPDATE','CIN_KLIENT','KLIENT_ID='||P_KLIENT_ID,'Dezaktywowano klienta (archiwum)');
    COMMIT;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20023, 'BLAD: Nie istnieje KLIENT_ID='||P_KLIENT_ID);
  END;

END CIN_PAK_KLIENT;
/

-- TRIGGER BLOKADY ZAJETEGO MIEJSCA
CREATE OR REPLACE TRIGGER CIN_TRG_MIEJSCE_BLOKADA
BEFORE INSERT ON CIN_REZ_MIEJSCE
FOR EACH ROW
DECLARE
  v_seans_id NUMBER;
  v_cnt      NUMBER;
BEGIN
  SELECT SEANS_ID INTO v_seans_id FROM CIN_REZERWACJA WHERE REZERWACJA_ID = :NEW.REZERWACJA_ID;

  SELECT COUNT(*) INTO v_cnt
  FROM CIN_REZ_MIEJSCE rm
  JOIN CIN_REZERWACJA r ON r.REZERWACJA_ID = rm.REZERWACJA_ID
  WHERE r.SEANS_ID = v_seans_id
    AND rm.RZAD = :NEW.RZAD
    AND rm.MIEJSCE = :NEW.MIEJSCE;

  IF v_cnt > 0 THEN
    RAISE_APPLICATION_ERROR(-20031, 'BLAD: Miejsce jest juz zajete na tym seansie.');
  END IF;
END;
/

-- TRIGGER ARCHIWIZACJI I LOGOWANIA DELETE SEANS
CREATE OR REPLACE TRIGGER CIN_TRG_SEANS_ARCH_DEL
BEFORE DELETE ON CIN_SEANS
FOR EACH ROW
BEGIN
  INSERT INTO CIN_ARC_SEANS (SEANS_ID, FILM_ID, SALA_ID, DATA_START, CENA, STATUS, DATA_UTWORZENIA, POWOD)
  VALUES (:OLD.SEANS_ID, :OLD.FILM_ID, :OLD.SALA_ID, :OLD.DATA_START, :OLD.CENA, :OLD.STATUS, :OLD.DATA_UTWORZENIA, 'DELETE TRIGGER');

  CIN_PAK_LOG.LOGUJ('DELETE', 'CIN_SEANS', 'SEANS_ID='||:OLD.SEANS_ID, 'Usunieto seans (trigger)');
END;
/

-- PAKIET PODSUMOWAN (MIESIAC+RANK)
CREATE OR REPLACE PACKAGE CIN_PAK_PODSUMOWANIE AS
  PROCEDURE GENERUJ_MIESIAC(P_ROK IN NUMBER, P_MIESIAC IN NUMBER);
END CIN_PAK_PODSUMOWANIE;
/
CREATE OR REPLACE PACKAGE BODY CIN_PAK_PODSUMOWANIE AS
  PROCEDURE GENERUJ_MIESIAC(P_ROK IN NUMBER, P_MIESIAC IN NUMBER) IS
    v_od DATE; v_do DATE;
  BEGIN
    v_od := TO_DATE(P_ROK||'-'||LPAD(P_MIESIAC,2,'0')||'-01','YYYY-MM-DD');
    v_do := ADD_MONTHS(v_od, 1);

    DELETE FROM CIN_POD_SPRZEDAZ_MIESIAC WHERE ROK = P_ROK AND MIESIAC = P_MIESIAC;
    DELETE FROM CIN_POD_FREKWENCJA_MIESIAC WHERE ROK = P_ROK AND MIESIAC = P_MIESIAC;
    DELETE FROM CIN_POD_RANKING_FILM_MIESIAC WHERE ROK = P_ROK AND MIESIAC = P_MIESIAC;

    INSERT INTO CIN_POD_SPRZEDAZ_MIESIAC (ROK, MIESIAC, KINO_ID, PRZYCHOD, LICZBA_PLATNOSCI)
    SELECT P_ROK, P_MIESIAC, k.KINO_ID, NVL(SUM(p.KWOTA),0), COUNT(p.PLATNOSC_ID)
    FROM CIN_KINO k
    LEFT JOIN CIN_SALA sa ON sa.KINO_ID = k.KINO_ID
    LEFT JOIN CIN_SEANS se ON se.SALA_ID = sa.SALA_ID
    LEFT JOIN CIN_REZERWACJA r ON r.SEANS_ID = se.SEANS_ID AND r.STATUS = 'POTWIERDZONA'
    LEFT JOIN CIN_PLATNOSC p ON p.REZERWACJA_ID = r.REZERWACJA_ID AND p.STATUS = 'ZAPLACONA'
    WHERE se.DATA_START >= v_od AND se.DATA_START < v_do
    GROUP BY k.KINO_ID;

    INSERT INTO CIN_POD_FREKWENCJA_MIESIAC (ROK, MIESIAC, KINO_ID, LICZBA_BILETOW, LICZBA_SEANSOW)
    SELECT P_ROK, P_MIESIAC, k.KINO_ID, COUNT(rm.REZ_MIEJSCE_ID), COUNT(DISTINCT se.SEANS_ID)
    FROM CIN_KINO k
    JOIN CIN_SALA sa ON sa.KINO_ID = k.KINO_ID
    JOIN CIN_SEANS se ON se.SALA_ID = sa.SALA_ID
    LEFT JOIN CIN_REZERWACJA r ON r.SEANS_ID = se.SEANS_ID AND r.STATUS = 'POTWIERDZONA'
    LEFT JOIN CIN_REZ_MIEJSCE rm ON rm.REZERWACJA_ID = r.REZERWACJA_ID
    WHERE se.DATA_START >= v_od AND se.DATA_START < v_do
    GROUP BY k.KINO_ID;

    INSERT INTO CIN_POD_RANKING_FILM_MIESIAC (ROK, MIESIAC, FILM_ID, LICZBA_BILETOW, RANGA)
    SELECT P_ROK, P_MIESIAC, film_id, liczba_biletow,
           RANK() OVER (ORDER BY liczba_biletow DESC)
    FROM (
      SELECT f.FILM_ID AS film_id, COUNT(rm.REZ_MIEJSCE_ID) AS liczba_biletow
      FROM CIN_FILM f
      JOIN CIN_SEANS se ON se.FILM_ID = f.FILM_ID
      LEFT JOIN CIN_REZERWACJA r ON r.SEANS_ID = se.SEANS_ID AND r.STATUS = 'POTWIERDZONA'
      LEFT JOIN CIN_REZ_MIEJSCE rm ON rm.REZERWACJA_ID = r.REZERWACJA_ID
      WHERE se.DATA_START >= v_od AND se.DATA_START < v_do
      GROUP BY f.FILM_ID
    );

    CIN_PAK_LOG.LOGUJ('PROC','CIN_PAK_PODSUMOWANIE','ROK='||P_ROK||', MIESIAC='||P_MIESIAC,'Wygenerowano podsumowania miesieczne');
    COMMIT;
  END;
END CIN_PAK_PODSUMOWANIE;
/

-- WIDOKI RAPORTOWE
CREATE OR REPLACE VIEW CIN_W_SEANSE_DZIS AS
SELECT se.SEANS_ID, k.NAZWA AS KINO, sa.NUMER_SALI, f.TYTUL AS FILM, se.DATA_START, se.CENA, se.STATUS
FROM CIN_SEANS se
JOIN CIN_FILM f ON f.FILM_ID = se.FILM_ID
JOIN CIN_SALA sa ON sa.SALA_ID = se.SALA_ID
JOIN CIN_KINO k ON k.KINO_ID = sa.KINO_ID
WHERE TRUNC(se.DATA_START) = TRUNC(SYSDATE)
ORDER BY se.DATA_START;

CREATE OR REPLACE VIEW CIN_W_SPRZEDAZ_PO_KINIE AS
SELECT k.NAZWA AS KINO, SUM(p.KWOTA) AS PRZYCHOD, COUNT(p.PLATNOSC_ID) AS LICZBA_PLATNOSCI
FROM CIN_PLATNOSC p
JOIN CIN_REZERWACJA r ON r.REZERWACJA_ID = p.REZERWACJA_ID
JOIN CIN_SEANS se ON se.SEANS_ID = r.SEANS_ID
JOIN CIN_SALA sa ON sa.SALA_ID = se.SALA_ID
JOIN CIN_KINO k ON k.KINO_ID = sa.KINO_ID
WHERE p.STATUS = 'ZAPLACONA'
  AND se.DATA_START >= TRUNC(SYSDATE, 'MM')
  AND se.DATA_START < ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1)
GROUP BY k.NAZWA;

CREATE OR REPLACE VIEW CIN_W_FREKWENCJA_PO_FILMIE AS
SELECT f.TYTUL AS FILM, COUNT(rm.REZ_MIEJSCE_ID) AS LICZBA_BILETOW
FROM CIN_FILM f
JOIN CIN_SEANS se ON se.FILM_ID = f.FILM_ID
LEFT JOIN CIN_REZERWACJA r ON r.SEANS_ID = se.SEANS_ID AND r.STATUS = 'POTWIERDZONA'
LEFT JOIN CIN_REZ_MIEJSCE rm ON rm.REZERWACJA_ID = r.REZERWACJA_ID
WHERE se.DATA_START >= TRUNC(SYSDATE, 'MM')
  AND se.DATA_START < ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1)
GROUP BY f.TYTUL;

CREATE OR REPLACE VIEW CIN_W_TOP_FILMY_MIESIAC AS
SELECT FILM, LICZBA_BILETOW, RANK() OVER (ORDER BY LICZBA_BILETOW DESC) AS RANGA
FROM (
  SELECT f.TYTUL AS FILM, COUNT(rm.REZ_MIEJSCE_ID) AS LICZBA_BILETOW
  FROM CIN_FILM f
  JOIN CIN_SEANS se ON se.FILM_ID = f.FILM_ID
  LEFT JOIN CIN_REZERWACJA r ON r.SEANS_ID = se.SEANS_ID AND r.STATUS = 'POTWIERDZONA'
  LEFT JOIN CIN_REZ_MIEJSCE rm ON rm.REZERWACJA_ID = r.REZERWACJA_ID
  WHERE se.DATA_START >= TRUNC(SYSDATE, 'MM')
    AND se.DATA_START < ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1)
  GROUP BY f.TYTUL
);

-- DANE TESTOWE STARTOWE
INSERT INTO CIN_KINO (NAZWA, MIASTO, ADRES, TELEFON, EMAIL) VALUES ('Kino Centrum', 'Warszawa', 'ul. Marszalkowska 10', '501111222', 'centrum@kino.pl');
INSERT INTO CIN_KINO (NAZWA, MIASTO, ADRES, TELEFON, EMAIL) VALUES ('Kino Plaza', 'Krakow', 'ul. Dluga 5', '502333444', 'plaza@kino.pl');

INSERT INTO CIN_SALA (KINO_ID, NUMER_SALI, LICZBA_MIEJSC) SELECT KINO_ID, 1, 80  FROM CIN_KINO WHERE NAZWA = 'Kino Centrum';
INSERT INTO CIN_SALA (KINO_ID, NUMER_SALI, LICZBA_MIEJSC) SELECT KINO_ID, 2, 120 FROM CIN_KINO WHERE NAZWA = 'Kino Centrum';
INSERT INTO CIN_SALA (KINO_ID, NUMER_SALI, LICZBA_MIEJSC) SELECT KINO_ID, 1, 70  FROM CIN_KINO WHERE NAZWA = 'Kino Plaza';
INSERT INTO CIN_SALA (KINO_ID, NUMER_SALI, LICZBA_MIEJSC) SELECT KINO_ID, 2, 100 FROM CIN_KINO WHERE NAZWA = 'Kino Plaza';

INSERT INTO CIN_FILM (TYTUL, CZAS_MIN, KATEGORIA, MIN_WIEK) VALUES ('Interstellar', 169, 'Sci-Fi', 12);
INSERT INTO CIN_FILM (TYTUL, CZAS_MIN, KATEGORIA, MIN_WIEK) VALUES ('Shrek', 90, 'Animacja', 0);
INSERT INTO CIN_FILM (TYTUL, CZAS_MIN, KATEGORIA, MIN_WIEK) VALUES ('Oppenheimer', 180, 'Dramat', 16);
INSERT INTO CIN_FILM (TYTUL, CZAS_MIN, KATEGORIA, MIN_WIEK) VALUES ('Incepcja', 148, 'Thriller', 12);

INSERT INTO CIN_SEANS (FILM_ID, SALA_ID, DATA_START, CENA, STATUS)
SELECT f.FILM_ID, s.SALA_ID, TRUNC(SYSDATE) + (18/24), 28.00, 'AKTYWNY'
FROM CIN_FILM f, CIN_SALA s, CIN_KINO k
WHERE f.TYTUL='Interstellar' AND k.NAZWA='Kino Centrum' AND s.KINO_ID=k.KINO_ID AND s.NUMER_SALI=1;

INSERT INTO CIN_SEANS (FILM_ID, SALA_ID, DATA_START, CENA, STATUS)
SELECT f.FILM_ID, s.SALA_ID, TRUNC(SYSDATE) + 1 + (16/24), 24.00, 'AKTYWNY'
FROM CIN_FILM f, CIN_SALA s, CIN_KINO k
WHERE f.TYTUL='Shrek' AND k.NAZWA='Kino Centrum' AND s.KINO_ID=k.KINO_ID AND s.NUMER_SALI=1;

INSERT INTO CIN_SEANS (FILM_ID, SALA_ID, DATA_START, CENA, STATUS)
SELECT f.FILM_ID, s.SALA_ID, TRUNC(SYSDATE) + (20/24), 30.00, 'AKTYWNY'
FROM CIN_FILM f, CIN_SALA s, CIN_KINO k
WHERE f.TYTUL='Oppenheimer' AND k.NAZWA='Kino Centrum' AND s.KINO_ID=k.KINO_ID AND s.NUMER_SALI=2;

INSERT INTO CIN_SEANS (FILM_ID, SALA_ID, DATA_START, CENA, STATUS)
SELECT f.FILM_ID, s.SALA_ID, TRUNC(SYSDATE) + 1 + (19/24), 26.00, 'AKTYWNY'
FROM CIN_FILM f, CIN_SALA s, CIN_KINO k
WHERE f.TYTUL='Incepcja' AND k.NAZWA='Kino Plaza' AND s.KINO_ID=k.KINO_ID AND s.NUMER_SALI=1;

INSERT INTO CIN_SEANS (FILM_ID, SALA_ID, DATA_START, CENA, STATUS)
SELECT f.FILM_ID, s.SALA_ID, TRUNC(SYSDATE) + 2 + (17/24), 25.00, 'AKTYWNY'
FROM CIN_FILM f, CIN_SALA s, CIN_KINO k
WHERE f.TYTUL='Shrek' AND k.NAZWA='Kino Plaza' AND s.KINO_ID=k.KINO_ID AND s.NUMER_SALI=2;

INSERT INTO CIN_SEANS (FILM_ID, SALA_ID, DATA_START, CENA, STATUS)
SELECT f.FILM_ID, s.SALA_ID, TRUNC(SYSDATE) + 2 + (20/24), 29.00, 'AKTYWNY'
FROM CIN_FILM f, CIN_SALA s, CIN_KINO k
WHERE f.TYTUL='Interstellar' AND k.NAZWA='Kino Plaza' AND s.KINO_ID=k.KINO_ID AND s.NUMER_SALI=2;

INSERT INTO CIN_KLIENT (IMIE, NAZWISKO, EMAIL, TELEFON) VALUES ('Anna', 'Kowalska', 'anna.kowalska@mail.pl', '600100200');
INSERT INTO CIN_KLIENT (IMIE, NAZWISKO, EMAIL, TELEFON) VALUES ('Jan', 'Nowak', 'jan.nowak@mail.pl', '600300400');
INSERT INTO CIN_KLIENT (IMIE, NAZWISKO, EMAIL, TELEFON) VALUES ('Maria', 'Wisniewska', 'maria.wisniewska@mail.pl', '600500600');

COMMIT;

-- REZERWACJE TESTOWE (3/7/3)
DECLARE
  v_rez_id NUMBER;
BEGIN
  INSERT INTO CIN_REZERWACJA (KLIENT_ID, SEANS_ID, STATUS) VALUES (1, 1, 'POTWIERDZONA') RETURNING REZERWACJA_ID INTO v_rez_id;
  INSERT INTO CIN_REZ_MIEJSCE (REZERWACJA_ID, RZAD, MIEJSCE) VALUES (v_rez_id, 1, 1);
  INSERT INTO CIN_REZ_MIEJSCE (REZERWACJA_ID, RZAD, MIEJSCE) VALUES (v_rez_id, 1, 2);
  INSERT INTO CIN_PLATNOSC (REZERWACJA_ID, KWOTA, METODA, STATUS) VALUES (v_rez_id, 56.00, 'KARTA', 'ZAPLACONA');

  INSERT INTO CIN_REZERWACJA (KLIENT_ID, SEANS_ID, STATUS) VALUES (2, 3, 'POTWIERDZONA') RETURNING REZERWACJA_ID INTO v_rez_id;
  INSERT INTO CIN_REZ_MIEJSCE (REZERWACJA_ID, RZAD, MIEJSCE) VALUES (v_rez_id, 2, 5);
  INSERT INTO CIN_REZ_MIEJSCE (REZERWACJA_ID, RZAD, MIEJSCE) VALUES (v_rez_id, 2, 6);
  INSERT INTO CIN_REZ_MIEJSCE (REZERWACJA_ID, RZAD, MIEJSCE) VALUES (v_rez_id, 2, 7);
  INSERT INTO CIN_PLATNOSC (REZERWACJA_ID, KWOTA, METODA, STATUS) VALUES (v_rez_id, 90.00, 'BLIK', 'ZAPLACONA');

  INSERT INTO CIN_REZERWACJA (KLIENT_ID, SEANS_ID, STATUS) VALUES (3, 4, 'POTWIERDZONA') RETURNING REZERWACJA_ID INTO v_rez_id;
  INSERT INTO CIN_REZ_MIEJSCE (REZERWACJA_ID, RZAD, MIEJSCE) VALUES (v_rez_id, 3, 10);
  INSERT INTO CIN_REZ_MIEJSCE (REZERWACJA_ID, RZAD, MIEJSCE) VALUES (v_rez_id, 3, 11);
  INSERT INTO CIN_PLATNOSC (REZERWACJA_ID, KWOTA, METODA, STATUS) VALUES (v_rez_id, 52.00, 'GOTOWKA', 'ZAPLACONA');

  COMMIT;
END;
/

-- DEMO/TEST (F5)
-- 1) TEST: LADOWANIE FILM ze STG (1 dobry, 1 bledny)
DELETE FROM CIN_STG_FILM;
COMMIT;

INSERT INTO CIN_STG_FILM (TYTUL, CZAS_MIN, KATEGORIA, MIN_WIEK) VALUES ('Demo Film OK', 100, 'Test', 12);
INSERT INTO CIN_STG_FILM (TYTUL, CZAS_MIN, KATEGORIA, MIN_WIEK) VALUES ('Demo Film Bledny', 0, 'Test', 0);
COMMIT;

BEGIN
  CIN_PAK_LADOWANIE.LADUJ_FILMY_Z_STG('DEMO: wsad filmow');
END;
/

SELECT * FROM CIN_LAD_BATCH ORDER BY BATCH_ID DESC;
SELECT * FROM CIN_LAD_BLEDY ORDER BY BLAD_ID DESC;

-- 2) TEST: LADOWANIE SEANS ze STG (1 dobry, 1 bledny - kino nie istnieje)
DELETE FROM CIN_STG_SEANS;
COMMIT;

INSERT INTO CIN_STG_SEANS (TYTUL_FILMU, KINO_NAZWA, NUMER_SALI, DATA_START, CENA)
VALUES ('Interstellar', 'Kino Centrum', 1, TRUNC(SYSDATE)+5+(18/24), 21);

INSERT INTO CIN_STG_SEANS (TYTUL_FILMU, KINO_NAZWA, NUMER_SALI, DATA_START, CENA)
VALUES ('Interstellar', 'Kino Nie Istnieje', 1, TRUNC(SYSDATE)+5+(20/24), 21);

COMMIT;

BEGIN
  CIN_PAK_LADOWANIE.LADUJ_SEANSE_Z_STG('DEMO: wsad seansow');
END;
/

SELECT * FROM CIN_LAD_BATCH ORDER BY BATCH_ID DESC;
SELECT * FROM CIN_LAD_BLEDY ORDER BY BLAD_ID DESC;

-- 3) TEST: Pakiet SEANS - kolizja (ORA-20003)
BEGIN
  CIN_PAK_SEANS.DODAJ_SEANS(1, 1, TRUNC(SYSDATE)+6+(10/24), 20, 'AKTYWNY');
END;
/
BEGIN
  CIN_PAK_SEANS.DODAJ_SEANS(2, 1, TRUNC(SYSDATE)+6+(10/24), 20, 'AKTYWNY');
END;
/

-- 4) TEST: Pakiet KLIENT - bledny email (ORA-20021)
DECLARE
  v_id NUMBER;
BEGIN
  v_id := CIN_PAK_KLIENT.DODAJ_KLIENTA('Demo','Email','zly_email','700000000');
END;
/

-- 5) TEST: Pakiet REZERWACJA - zajete miejsce (ORA-20014) + trigger (ORA-20031)
DECLARE
  v_rez1 NUMBER;
  v_rez2 NUMBER;
BEGIN
  v_rez1 := CIN_PAK_REZERWACJA.UTWORZ_REZERWACJE(1, 1, 'NOWA');
  CIN_PAK_REZERWACJA.DODAJ_MIEJSCE(v_rez1, 9, 9);
  CIN_PAK_REZERWACJA.POTWIERDZ_REZERWACJE(v_rez1);

  v_rez2 := CIN_PAK_REZERWACJA.UTWORZ_REZERWACJE(2, 1, 'NOWA');
  CIN_PAK_REZERWACJA.DODAJ_MIEJSCE(v_rez2, 9, 9);
END;
/

DECLARE
  v_rez NUMBER;
BEGIN
  v_rez := CIN_PAK_REZERWACJA.UTWORZ_REZERWACJE(3, 1, 'NOWA');
  INSERT INTO CIN_REZ_MIEJSCE (REZERWACJA_ID, RZAD, MIEJSCE) VALUES (v_rez, 9, 9);
  COMMIT;
END;
/

-- 6) TEST: Trigger archiwizacji seansu przy DELETE (archiwum + log)
DELETE FROM CIN_SEANS
WHERE SALA_ID = 1
  AND DATA_START = TRUNC(SYSDATE)+6+(10/24);
COMMIT;

SELECT * FROM CIN_ARC_SEANS ORDER BY ARC_ID DESC FETCH FIRST 5 ROWS ONLY;

-- 7) TEST: Podsumowania biezacego miesiaca
BEGIN
  CIN_PAK_PODSUMOWANIE.GENERUJ_MIESIAC(
    P_ROK => EXTRACT(YEAR FROM SYSDATE),
    P_MIESIAC => EXTRACT(MONTH FROM SYSDATE)
  );
END;
/

SELECT p.ROK, p.MIESIAC, k.NAZWA AS KINO, p.PRZYCHOD, p.LICZBA_PLATNOSCI
FROM CIN_POD_SPRZEDAZ_MIESIAC p
JOIN CIN_KINO k ON k.KINO_ID = p.KINO_ID
ORDER BY k.NAZWA;

SELECT r.RANGA, f.TYTUL, r.LICZBA_BILETOW
FROM CIN_POD_RANKING_FILM_MIESIAC r
JOIN CIN_FILM f ON f.FILM_ID = r.FILM_ID
ORDER BY r.RANGA, f.TYTUL;

-- 8) Widoki raportowe
SELECT * FROM CIN_W_SPRZEDAZ_PO_KINIE;
SELECT * FROM CIN_W_TOP_FILMY_MIESIAC ORDER BY RANGA, FILM;

-- 9) Log (ostatnie wpisy)
SELECT LOG_ID, DATA_ZDARZENIA, TYP_OPERACJI, OBIEKT, KLUCZ_OPIS, OPIS
FROM CIN_LOG_OPERACJA
ORDER BY LOG_ID DESC FETCH FIRST 15 ROWS ONLY;
