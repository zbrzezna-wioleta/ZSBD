--Zadanie 1--

CREATE TABLE archiwum_departamentow (
    id               NUMBER,
    nazwa            VARCHAR2(100),
    data_zamkniecia  DATE,
    ostatni_manager  VARCHAR2(100)
);

CREATE OR REPLACE TRIGGER tr_archiwum_departamentow
BEFORE DELETE ON departments
FOR EACH ROW
DECLARE
    v_manager_name VARCHAR2(100);
BEGIN
    
    SELECT first_name || ' ' || last_name
    INTO v_manager_name
    FROM employees
    WHERE employee_id = :OLD.manager_id;

    INSERT INTO archiwum_departamentow
    VALUES (
        :OLD.department_id,
        :OLD.department_name,
        SYSDATE,
        v_manager_name
    );
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        INSERT INTO archiwum_departamentow
        VALUES (
            :OLD.department_id,
            :OLD.department_name,
            SYSDATE,
            'BRAK MANAGERA'
        );
END;
/

SELECT department_id 
FROM departments d
WHERE NOT EXISTS (
    SELECT 1 FROM employees e WHERE e.department_id = d.department_id
);

DELETE FROM departments WHERE department_id = 270;
COMMIT;

SELECT * FROM archiwum_departamentow;

--Zadanie 2--

CREATE TABLE zlodzieje (
    id          NUMBER GENERATED BY DEFAULT AS IDENTITY,
    user_name   VARCHAR2(100),
    czas_zmiany DATE,
    akcja       VARCHAR2(50),
    salary      NUMBER
);

CREATE OR REPLACE TRIGGER tr_salary_check
BEFORE INSERT OR UPDATE ON employees
FOR EACH ROW
BEGIN
    IF :NEW.salary < 2000 OR :NEW.salary > 26000 THEN
        INSERT INTO zlodzieje (user_name, czas_zmiany, akcja, salary)
        VALUES (USER, SYSDATE, 'PROBA ZMIANY ZAROBKOW', :NEW.salary);

        RAISE_APPLICATION_ERROR(-20080,
            'Wynagrodzenie poza dozwolonym zakresem 2000-26000!');
    END IF;
END;
/

UPDATE employees
SET salary = 500
WHERE employee_id = 100;

SELECT * FROM zlodzieje;

UPDATE employees
SET salary = 4000
WHERE employee_id = 100;

--Zadanie 3--

CREATE SEQUENCE emp_auto_seq START WITH 300 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER tr_auto_inc_emp
BEFORE INSERT ON employees
FOR EACH ROW
BEGIN
    IF :NEW.employee_id IS NULL THEN
        :NEW.employee_id := emp_auto_seq.NEXTVAL;
    END IF;
END;
/

INSERT INTO employees (first_name, last_name, salary, department_id, job_id, hire_date)
VALUES ('Test', 'Auto', 5000, 50, 'IT_PROG', SYSDATE);

SELECT employee_id FROM employees WHERE last_name = 'Auto';


--Zadanie 4--

CREATE OR REPLACE TRIGGER tr_block_job_grades
BEFORE INSERT OR UPDATE OR DELETE ON job_grades
BEGIN
    RAISE_APPLICATION_ERROR(-20090, 'Tabela JOB_GRADES jest tylko do odczytu!');
END;
/

UPDATE job_grades SET min_salary = 10 WHERE grade = 'A';

--Zadanie 5--

CREATE OR REPLACE TRIGGER tr_protect_job_salary
BEFORE UPDATE OF min_salary, max_salary ON jobs
FOR EACH ROW
BEGIN
    :NEW.min_salary := :OLD.min_salary;
    :NEW.max_salary := :OLD.max_salary;
END;
/

UPDATE jobs
SET min_salary = 1
WHERE job_id = 'IT_PROG';

SELECT min_salary FROM jobs WHERE job_id = 'IT_PROG';

--Zadanie 6--

DELETE FROM departments WHERE department_id = X;
SELECT * FROM archiwum_departamentow;


UPDATE employees SET salary = 100 WHERE employee_id = 101;
SELECT * FROM zlodzieje;


INSERT INTO employees(...);
SELECT employee_id FROM employees ORDER BY employee_id DESC;


DELETE FROM job_grades;


UPDATE jobs SET min_salary = 1 WHERE job_id = 'IT_PROG';



