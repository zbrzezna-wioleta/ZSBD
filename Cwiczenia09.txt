--Zadanie 1--

CREATE OR REPLACE PACKAGE pkg_all_functions AS

    FUNCTION f_get_job_title(p_job_id jobs.job_id%TYPE)
        RETURN VARCHAR2;

    FUNCTION f_yearly_salary(p_emp_id employees.employee_id%TYPE)
        RETURN NUMBER;

    FUNCTION f_area_code(p_phone VARCHAR2)
        RETURN VARCHAR2;

    FUNCTION f_first_last_upper(p_text VARCHAR2)
        RETURN VARCHAR2;

    FUNCTION f_pesel_to_date(p_pesel VARCHAR2)
        RETURN VARCHAR2;

    FUNCTION f_country_stats(p_country_name VARCHAR2)
        RETURN VARCHAR2;

    FUNCTION f_access_id(p_first_name VARCHAR2, p_last_name VARCHAR2, p_phone VARCHAR2)
        RETURN VARCHAR2;

END pkg_all_functions;
/

SELECT pkg_all_functions.f_first_last_upper('ania kowalska') FROM dual;

SELECT pkg_all_functions.f_pesel_to_date('01211512345') FROM dual;

SELECT pkg_all_functions.f_area_code('(123)456-789') FROM dual;


--Zadanie 2--

CREATE OR REPLACE PACKAGE pkg_regions AS

    PROCEDURE add_region(p_region_id NUMBER, p_name VARCHAR2);
    PROCEDURE update_region(p_region_id NUMBER, p_name VARCHAR2);
    PROCEDURE delete_region(p_region_id NUMBER);

    FUNCTION get_region_name(p_region_id NUMBER)
        RETURN VARCHAR2;

    FUNCTION list_regions RETURN SYS_REFCURSOR;

END pkg_regions;
/

CREATE OR REPLACE PACKAGE BODY pkg_regions AS

    PROCEDURE add_region(p_region_id NUMBER, p_name VARCHAR2) AS
    BEGIN
        INSERT INTO regions (region_id, region_name)
        VALUES (p_region_id, p_name);
    END;

    PROCEDURE update_region(p_region_id NUMBER, p_name VARCHAR2) AS
    BEGIN
        UPDATE regions
        SET region_name = p_name
        WHERE region_id = p_region_id;
    END;

    PROCEDURE delete_region(p_region_id NUMBER) AS
    BEGIN
        DELETE FROM regions WHERE region_id = p_region_id;
    END;

    FUNCTION get_region_name(p_region_id NUMBER) RETURN VARCHAR2 AS
        v_name VARCHAR2(100);
    BEGIN
        SELECT region_name INTO v_name
        FROM regions
        WHERE region_id = p_region_id;
        RETURN v_name;
    END;

    FUNCTION list_regions RETURN SYS_REFCURSOR AS
        c SYS_REFCURSOR;
    BEGIN
        OPEN c FOR SELECT * FROM regions;
        RETURN c;
    END;

END pkg_regions;
/

BEGIN
    pkg_regions.add_region(99, 'TestRegion');
END;
/
SELECT * FROM regions WHERE region_id = 99;

BEGIN
    pkg_regions.update_region(99, 'RegionX');
END;
/ 
SELECT * FROM regions WHERE region_id = 99;

BEGIN
    pkg_regions.delete_region(99);
END;
/ 

SELECT pkg_regions.get_region_name(1) FROM dual;

VAR c REFCURSOR
EXEC :c := pkg_regions.list_regions;
PRINT c;


--Zadanie 3--

CREATE TABLE audit_regions (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY,
    user_name VARCHAR2(50),
    error_msg VARCHAR2(400),
    time_stamp DATE
);

CREATE OR REPLACE PACKAGE pkg_regions_ex AS

    e_region_exists EXCEPTION;
    PRAGMA EXCEPTION_INIT(e_region_exists, -20001);

    e_region_has_countries EXCEPTION;
    PRAGMA EXCEPTION_INIT(e_region_has_countries, -20002);

    PROCEDURE add_region(p_region_id NUMBER, p_name VARCHAR2);
    PROCEDURE delete_region(p_region_id NUMBER);

END pkg_regions_ex;
/

CREATE OR REPLACE PACKAGE BODY pkg_regions_ex AS

    PROCEDURE log_error(p_msg VARCHAR2) AS
    BEGIN
        INSERT INTO audit_regions(user_name, error_msg, time_stamp)
        VALUES (USER, p_msg, SYSDATE);
    END;

    PROCEDURE add_region(p_region_id NUMBER, p_name VARCHAR2) AS
        v_count NUMBER;
    BEGIN
        SELECT COUNT(*)
        INTO v_count
        FROM regions
        WHERE region_name = p_name;

        IF v_count > 0 THEN
            log_error('Próba dodania istniejącego regionu: ' || p_name);
            RAISE_APPLICATION_ERROR(-20001, 'Region już istnieje!');
        END IF;

        INSERT INTO regions(region_id, region_name)
        VALUES(p_region_id, p_name);
    END;

    PROCEDURE delete_region(p_region_id NUMBER) AS
        v_count NUMBER;
    BEGIN
        SELECT COUNT(*)
        INTO v_count
        FROM countries
        WHERE region_id = p_region_id;

        IF v_count > 0 THEN
            log_error('Próba usunięcia regionu z krajami.');
            RAISE_APPLICATION_ERROR(-20002, 'Nie można usunąć regionu!');
        END IF;

        DELETE FROM regions WHERE region_id = p_region_id;
    END;

END pkg_regions_ex;
/

BEGIN
    pkg_regions_ex.add_region(1, 'Europe');
END;
/

BEGIN
    pkg_regions_ex.delete_region(1);
END;
/


--Zadanie 4--

CREATE OR REPLACE PACKAGE pkg_dept_stats AS

    FUNCTION avg_salary(p_dept_id NUMBER) RETURN NUMBER;
    FUNCTION minmax_job_salary(p_job_id VARCHAR2) RETURN VARCHAR2;
    PROCEDURE report_departments;

END pkg_dept_stats;
/

CREATE OR REPLACE PACKAGE BODY pkg_dept_stats AS

    FUNCTION avg_salary(p_dept_id NUMBER) RETURN NUMBER AS
        v_avg NUMBER;
    BEGIN
        SELECT AVG(salary)
        INTO v_avg
        FROM employees
        WHERE department_id = p_dept_id;

        RETURN v_avg;
    END;

    FUNCTION minmax_job_salary(p_job_id VARCHAR2) RETURN VARCHAR2 AS
        v_min NUMBER;
        v_max NUMBER;
    BEGIN
        SELECT min_salary, max_salary
        INTO v_min, v_max
        FROM jobs
        WHERE job_id = p_job_id;

        RETURN 'Min=' || v_min || ' Max=' || v_max;
    END;

    PROCEDURE report_departments AS
    BEGIN
        FOR r IN (
            SELECT d.department_name, AVG(e.salary) AS avg_salary
            FROM departments d
            JOIN employees e ON e.department_id = d.department_id
            GROUP BY d.department_name
        ) LOOP
            DBMS_OUTPUT.PUT_LINE(r.department_name || ': ' || r.avg_salary);
        END LOOP;
    END;

END pkg_dept_stats;
/

SELECT pkg_dept_stats.avg_salary(50) FROM dual;

SELECT pkg_dept_stats.minmax_job_salary('IT_PROG') FROM dual;

SET SERVEROUTPUT ON;
BEGIN
    pkg_dept_stats.report_departments;
END;
/


--Zadanie 5--

CREATE OR REPLACE PACKAGE pkg_data_fix AS

    FUNCTION fix_phone(p_phone VARCHAR2) RETURN VARCHAR2;
    PROCEDURE mass_raise(p_job_id VARCHAR2, p_percent NUMBER);

END pkg_data_fix;
/


CREATE OR REPLACE PACKAGE BODY pkg_data_fix AS

    FUNCTION fix_phone(p_phone VARCHAR2) RETURN VARCHAR2 AS
    BEGIN
        RETURN REGEXP_REPLACE(p_phone, '[^0-9]', '');
    END;

    PROCEDURE mass_raise(p_job_id VARCHAR2, p_percent NUMBER) AS
    BEGIN
        UPDATE employees
        SET salary = salary * (1 + p_percent/100)
        WHERE job_id = p_job_id;
    END;

END pkg_data_fix;
/

SELECT pkg_data_fix.fix_phone('(123)-456 789') FROM dual;

BEGIN
    pkg_data_fix.mass_raise('IT_PROG', 10);
END;
/
SELECT first_name, salary FROM employees WHERE job_id = 'IT_PROG';

